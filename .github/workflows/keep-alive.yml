name: Keep Supabase Active - Persos United

on:
  schedule:
    - cron: '0 */6 * * *'  # Ejecutar cada 6 horas
  workflow_dispatch:        # Permitir ejecuci√≥n manual

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase
        id: ping
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Verificando conexi√≥n con Supabase..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "${SUPABASE_URL}/rest/v1/inscripciones?select=id&limit=1" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")

          echo "C√≥digo de estado: $STATUS_CODE"

          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "‚ùå Fallo en la conexi√≥n con Supabase (HTTP $STATUS_CODE)"
            echo "status=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ Supabase activo y respondiendo correctamente."
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Notificar por correo si falla
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ö†Ô∏è Supabase Persos United - Error de conexi√≥n"
          to: "emennn45@gmail.com"
          from: "Supabase Monitor <${{ secrets.MAIL_USERNAME }}>"
          body: |
            Hola Emennn üëã

            El monitor detect√≥ un error al conectar con tu proyecto Supabase (Persos United).
            Posible causa: base dormida, clave expirada o endpoint inaccesible.

            Verifica el estado en: https://supabase.com/dashboard

            ‚ö†Ô∏è Error detectado autom√°ticamente por el sistema de GitHub Actions.
